# ============================================
# Dockerfile for Python Agent SDK Service
# Deployment: Render (Claude Agent SDK for WhatsApp)
# ============================================

FROM python:3.11-slim

# ============================================
# System Setup
# ============================================
WORKDIR /app

# Install system dependencies and Node.js
RUN apt-get update && apt-get install -y \
    curl \
    ca-certificates \
    gnupg \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Claude Code CLI and GitHub MCP server globally
RUN npm install -g @anthropic-ai/claude-code @modelcontextprotocol/server-github

# Create non-root user for security
RUN useradd -m -u 1001 agentuser

# Ensure npm cache and global packages are accessible to non-root user
RUN mkdir -p /home/agentuser/.npm && \
    chown -R agentuser:agentuser /home/agentuser/.npm && \
    chmod -R 755 /usr/local/lib/node_modules

# ============================================
# Python Dependencies
# ============================================
# Copy requirements.txt first (for Docker layer caching)
COPY requirements.txt .

# Upgrade pip and install Python packages
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ============================================
# Copy Application Code
# ============================================
# Copy Python source code
COPY src/python/ ./src/python/

# ============================================
# Environment Variables (Set in Render Dashboard)
# ============================================
# - ANTHROPIC_API_KEY (required)
# - WHATSAPP_ACCESS_TOKEN (optional, for MCP server)
# - WHATSAPP_PHONE_NUMBER_ID (optional, for MCP server)
# - PORT (automatically set by Render, defaults to 8000)

# ============================================
# Expose Port
# ============================================
EXPOSE 8000

# ============================================
# Health Check
# ============================================
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:${PORT:-8000}/health || exit 1

# ============================================
# Switch to non-root user
# ============================================
RUN chown -R agentuser:agentuser /app
USER agentuser

# ============================================
# Start FastAPI Agent Service
# ============================================
CMD ["python", "src/python/main.py"]
